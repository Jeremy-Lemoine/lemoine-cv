{"ast":null,"code":"import { initializeApp } from \"firebase/app\";\nimport { getDatabase, set, ref, onValue, goOffline, update } from \"firebase/database\";\nconst firebaseConfig = {\n  apiKey: process.env.REACT_APP_FIREBASE_apiKey,\n  authDomain: process.env.REACT_APP_FIREBASE_authDomain,\n  projectId: process.env.REACT_APP_FIREBASE_projectId,\n  storageBucket: process.env.REACT_APP_FIREBASE_storageBucket,\n  messagingSenderId: process.env.REACT_APP_FIREBASE_messagingSenderId,\n  appId: process.env.REACT_APP_FIREBASE_appId,\n  databaseURL: process.env.REACT_APP_FIREBASE_databaseURL\n};\nconst app = initializeApp(firebaseConfig);\nconst defaultUserData = {\n  param1: 0,\n  param2: 0\n};\n\nclass Database {\n  constructor() {\n    this.database = getDatabase(app);\n  }\n\n  getRef(fullPath) {\n    return ref(this.database, fullPath);\n  }\n\n  async setItem(path, id, item) {\n    await set(this.getRef(`${path}/${id}`), item);\n  }\n\n  async readItem(path, id) {\n    return new Promise((resolve, reject) => {\n      const reference = this.getRef(`${path}/${id}`);\n      onValue(reference, item => {\n        if (item.val()) {\n          return resolve(item.val());\n        } else {\n          return reject();\n        }\n      });\n    });\n  }\n\n  async searchItems(path, query) {\n    const queriesList = Object.entries(query);\n    let retrieved = false;\n    return new Promise((resolve, reject) => {\n      const reference = this.getRef(`${path}/`);\n      onValue(reference, allItemsInPath => {\n        if (!retrieved) {\n          if (!allItemsInPath.val()) {\n            return reject();\n          }\n\n          const filteredItems = Object.entries(allItemsInPath.val()).filter(_ref => {\n            let [_, item] = _ref;\n            return queriesList.map(_ref2 => {\n              let [key, value] = _ref2;\n              return typeof item == 'object' && key in item && item[key] === value;\n            }).reduce((acc, cur) => acc && cur, true);\n          });\n\n          if (filteredItems.length === 0) {\n            return reject();\n          }\n\n          return resolve(filteredItems);\n        }\n      });\n    });\n  }\n\n  async createUser(userID) {\n    await this.setItem('users', userID, defaultUserData);\n    return defaultUserData;\n  }\n\n  async getUserData(userID) {\n    let retrieved = false;\n    return new Promise((resolve, _) => {\n      const reference = this.getRef(`users/${userID}`);\n      onValue(reference, async data_raw => {\n        if (!retrieved) {\n          retrieved = true;\n          const data = data_raw.val();\n\n          if (data) {\n            await this.checkUserDataFields(userID, data);\n            return resolve(data);\n          } else {\n            return resolve(this.createUser(userID));\n          }\n        }\n      });\n    });\n  }\n\n  async checkUserDataFields(userID, data) {\n    const updates = {};\n\n    for (let field of Object.keys(defaultUserData)) {\n      if (data[field] == null) {\n        updates[`/users/${userID}/${field}`] = defaultUserData[field];\n      }\n    }\n\n    if (updates !== {}) {\n      update(ref(this.database), updates);\n    }\n  }\n\n  disconnect() {\n    goOffline(this.database);\n  }\n\n}\n\nconst database = new Database();\nexport default database;","map":{"version":3,"sources":["D:/Bureau/Test React/coman-app/src/utils/database.js"],"names":["initializeApp","getDatabase","set","ref","onValue","goOffline","update","firebaseConfig","apiKey","process","env","REACT_APP_FIREBASE_apiKey","authDomain","REACT_APP_FIREBASE_authDomain","projectId","REACT_APP_FIREBASE_projectId","storageBucket","REACT_APP_FIREBASE_storageBucket","messagingSenderId","REACT_APP_FIREBASE_messagingSenderId","appId","REACT_APP_FIREBASE_appId","databaseURL","REACT_APP_FIREBASE_databaseURL","app","defaultUserData","param1","param2","Database","constructor","database","getRef","fullPath","setItem","path","id","item","readItem","Promise","resolve","reject","reference","val","searchItems","query","queriesList","Object","entries","retrieved","allItemsInPath","filteredItems","filter","_","map","key","value","reduce","acc","cur","length","createUser","userID","getUserData","data_raw","data","checkUserDataFields","updates","field","keys","disconnect"],"mappings":"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","sourcesContent":["import { initializeApp } from \"firebase/app\";\r\nimport { getDatabase, set, ref, onValue, goOffline, update } from \"firebase/database\"\r\n\r\nconst firebaseConfig = {\r\n  apiKey: process.env.REACT_APP_FIREBASE_apiKey,\r\n  authDomain: process.env.REACT_APP_FIREBASE_authDomain,\r\n  projectId: process.env.REACT_APP_FIREBASE_projectId,\r\n  storageBucket: process.env.REACT_APP_FIREBASE_storageBucket,\r\n  messagingSenderId: process.env.REACT_APP_FIREBASE_messagingSenderId,\r\n  appId: process.env.REACT_APP_FIREBASE_appId,\r\n  databaseURL: process.env.REACT_APP_FIREBASE_databaseURL\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst defaultUserData = {\r\n    param1: 0,\r\n    param2: 0\r\n}\r\n\r\nclass Database {\r\n\r\n    constructor() {\r\n        this.database = getDatabase(app);\r\n    }\r\n\r\n    getRef(fullPath) {\r\n        return ref(this.database, fullPath)\r\n    }\r\n    \r\n    async setItem(path, id, item) {\r\n        await set(this.getRef(`${path}/${id}`), item)\r\n    }\r\n\r\n    async readItem(path, id) {\r\n        return new Promise((resolve, reject) => {\r\n            const reference = this.getRef(`${path}/${id}`);\r\n            onValue(reference, (item) => {\r\n                if (item.val()) {\r\n                    return resolve(item.val());\r\n                } else {\r\n                    return reject();\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n    async searchItems(path, query) {\r\n        const queriesList = Object.entries(query);\r\n        let retrieved = false;\r\n        return new Promise((resolve, reject) => {\r\n            const reference = this.getRef(`${path}/`);\r\n            onValue(reference, (allItemsInPath) => {\r\n                if (!retrieved) {\r\n                    if (!allItemsInPath.val()) {\r\n                        return reject();\r\n                    }\r\n                    const filteredItems = Object.entries(allItemsInPath.val()).filter(\r\n                        ([ _, item ]) => {\r\n                            return queriesList.map( ([ key, value ]) => {\r\n                                return typeof(item) == 'object' && key in item && item[key] === value\r\n                            }).reduce((acc, cur) => acc && cur, true)\r\n                        }\r\n                    )\r\n                    if (filteredItems.length === 0) {\r\n                        return reject();\r\n                    }\r\n                    return resolve(filteredItems)\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n    async createUser(userID) {\r\n        await this.setItem('users', userID, defaultUserData);\r\n        return defaultUserData;\r\n    }\r\n\r\n    async getUserData(userID) {\r\n        let retrieved = false;\r\n        return new Promise((resolve, _) => {\r\n            const reference = this.getRef(`users/${userID}`);\r\n            onValue(reference, async (data_raw) => {\r\n                if (!retrieved) {\r\n                    retrieved = true;\r\n                    const data = data_raw.val();\r\n                    if (data) {\r\n                        await this.checkUserDataFields(userID, data)\r\n                        return resolve(data);\r\n                    } else {\r\n                        return resolve(this.createUser(userID));\r\n                    }\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n    async checkUserDataFields(userID, data) {\r\n        const updates = {}\r\n        for (let field of Object.keys(defaultUserData)) {\r\n            if (data[field] == null) {\r\n                updates[`/users/${userID}/${field}`] = defaultUserData[field];\r\n            }\r\n        }\r\n        if (updates !== {}) {\r\n            update(ref(this.database), updates)\r\n        }\r\n    }\r\n\r\n    disconnect() {\r\n        goOffline(this.database)\r\n    }\r\n\r\n}\r\n\r\nconst database = new Database();\r\n\r\nexport default database;"]},"metadata":{},"sourceType":"module"}